<!DOCTYPE html>
<html class="text-center text-sm-center text-md-center text-lg-center text-xl-center">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>EvaluacionDocente</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/Highlight-Clean.css">
    <link rel="stylesheet" href="assets/css/Login-Form-Clean.css">
    <link rel="stylesheet" href="assets/css/Navigation-Clean.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>

<body>

    <nav class="navbar navbar-light navbar-expand-md navigation-clean" style="background-color: #1c77ff;height: 78px;">
        <div class="container"><a class="navbar-brand" href="#" style="font-size: 34px;color: rgb(255,255,255);width: 330.547px;height: 47px;margin: -8;padding: -8;"><strong>Evaluacion Docente</strong><br></a>
            <div class="collapse navbar-collapse"></div><img src="assets/img/SEP_TI.png" style="width: 169px;margin: -6px;"><img src="assets/img/SEP.png" style="width: 200px;height: 63px;margin: -19px;padding: -18px;"><button data-target="#" data-toggle="collapse" class="navbar-toggler"><span class="sr-only">Toggle navigation</span><span class="navbar-toggler-icon"></span></button></div>
    </nav>
    <div style="width: 1200px;height: 259px;">
        <div class="container" style="height: 300px;">
            <div class="row" style="margin-top: 36px;">
                <div class="col-md-6" style="height: 303px;width: 662px;padding: 14px;margin: 0;margin-top: 0;background-color: #ffffff;"></div>
                <div class="col-md-6" style="padding: 14px;"></div>
            </div>
        </div>
    </div>
    <header style="background-color: #9c9c9c;margin: 59px;width: 1070px;"></header>
    <div style="width: 1200px;">
        <div class="container">
            <div class="row">
                <div class="col-md-6" style="height: 314px;opacity: 1;"></div>
                <div class="col-md-6"></div>
            </div>
        </div>
    </div>
<form method = "POST" action = "" enctype="multipart/form-data">
    <div class="text-left text-sm-center text-md-center text-lg-center text-xl-center" style="width: 200px;margin-top: 11px;"><span style="margin-top: 0px;margin-right: -166px;margin-bottom: -12px;font-size: 22px;color: rgb(0,0,0);">Adjuntar archivo</span><input type="file" name = "upload-personal" style="padding-top: 0px;margin-right: 0px;margin-left: 102px;margin-top: 12px;"><button class="btn btn-primary border rounded"
            type="submit" name = "submit-personal" style="margin-right: -340px;margin-left: 428px;margin-top: -63px;width: 114px;">Importar Personal</button></div>
</form>
<form method = "POST" action = "" enctype="multipart/form-data">
    <div class="text-left text-sm-center text-md-center text-lg-center text-xl-center" style="width: 200px;margin-top: 11px;"><span style="margin-top: 0px;margin-right: -166px;margin-bottom: -12px;font-size: 22px;color: rgb(0,0,0);">Adjuntar archivo</span><input type="file" name = "upload-grupos" style="padding-top: 0px;margin-right: 0px;margin-left: 102px;margin-top: 12px;"><button class="btn btn-primary border rounded"
            type="submit" name = "submit-grupos" style="margin-right: -340px;margin-left: 428px;margin-top: -63px;width: 114px;">Importar Grupos</button></div>
</form>

<form method = "POST" action = "" enctype="multipart/form-data">
    <div class="text-left text-sm-center text-md-center text-lg-center text-xl-center" style="width: 200px;margin-top: 11px;"><span style="margin-top: 0px;margin-right: -166px;margin-bottom: -12px;font-size: 22px;color: rgb(0,0,0);">Adjuntar archivo</span><input type="file" name = "upload-materias" style="padding-top: 0px;margin-right: 0px;margin-left: 102px;margin-top: 12px;"><button class="btn btn-primary border rounded"
            type="submit" name = "submit-materias" style="margin-right: -340px;margin-left: 428px;margin-top: -63px;width: 114px;">Importar Materias</button></div>
</form>

<form method = "POST" action = "" enctype="multipart/form-data">
    <div class="text-left text-sm-center text-md-center text-lg-center text-xl-center" style="width: 200px;margin-top: 11px;"><span style="margin-top: 0px;margin-right: -166px;margin-bottom: -12px;font-size: 22px;color: rgb(0,0,0);">Adjuntar archivo</span><input type="file" name = "upload-alumnos" style="padding-top: 0px;margin-right: 0px;margin-left: 102px;margin-top: 12px;"><button class="btn btn-primary border rounded"
            type="submit" name = "submit-alumnos" style="margin-right: -340px;margin-left: 428px;margin-top: -63px;width: 114px;">Importar Alumnos</button></div>
</form>

<form method = "POST" action = "" enctype="multipart/form-data">
    <div class="text-left text-sm-center text-md-center text-lg-center text-xl-center" style="width: 200px;margin-top: 11px;"><span style="margin-top: 0px;margin-right: -166px;margin-bottom: -12px;font-size: 22px;color: rgb(0,0,0);">Adjuntar archivo</span><input type="file" name = "upload-carreras" style="padding-top: 0px;margin-right: 0px;margin-left: 102px;margin-top: 12px;"><button class="btn btn-primary border rounded"
            type="submit" name = "submit-carreras" style="margin-right: -340px;margin-left: 428px;margin-top: -63px;width: 114px;">Importar Credenciales</button></div>
</form>

<form method = "POST" action = "" enctype="multipart/form-data">
    <div class="text-left text-sm-center text-md-center text-lg-center text-xl-center" style="width: 200px;margin-top: 11px;"><span style="margin-top: 0px;margin-right: -166px;margin-bottom: -12px;font-size: 22px;color: rgb(0,0,0);">Adjuntar archivo</span><input type="file" name = "upload-seleccion-materias" style="padding-top: 0px;margin-right: 0px;margin-left: 102px;margin-top: 12px;"><button class="btn btn-primary border rounded"
            type="submit" name = "submit-seleccion-materia" style="margin-right: -340px;margin-left: 428px;margin-top: -63px;width: 114px;">Importar Datos Individuales</button></div>
</form>

<form method = "POST" action = ""><button class="btn btn-primary border rounded"
            type="submit" name = "create-grupos-personas" style="margin-right: -340px;margin-left: 428px;margin-top: -63px;width: 114px;">Crear Tabla de Alumnos</button></div>
</form>


        
        <?php
$dbhost = "localhost";
$dbuser = "root";
$dbpass = "";
$dbname = "ed_test";
    
$conn = mysqli_connect($dbhost, $dbuser, $dbpass, $dbname);
    
if (!$conn)
{
    die("SERVIDOR NO CONECTADO: ".mysqli_error());
}
 
//$query = mysqli_query($conn, "");
//$nr = mysqli_num_rows($query);

$qryInicial = "CREATE TABLE IF NOT EXISTS `personal` (
       `personal_index` int(11) NOT NULL AUTO_INCREMENT,
       `rfc` varchar(13) DEFAULT NULL,
       `clave_area` int(6) DEFAULT NULL,
       `curp_empleado` varchar(18) DEFAULT NULL,
       `no_tarjeta` int(3) DEFAULT NULL,
       `apellidos_empleado` varchar(19) DEFAULT NULL,
       `nombre_empleado` varchar(18) DEFAULT NULL,
       `nombramiento` varchar(1) DEFAULT NULL,
       `area_academica` int(6) DEFAULT NULL,
       `tipo_personal` varchar(1) DEFAULT NULL,
       `apellido_paterno` varchar(10) DEFAULT NULL,
       `apellido_materno` varchar(12) DEFAULT NULL,
       `status_empleado` varchar(2) DEFAULT NULL,
       PRIMARY KEY (`personal_index`)
     ) ENGINE=InnoDB AUTO_INCREMENT=45 DEFAULT CHARSET=utf8;
  
      CREATE TABLE IF NOT EXISTS `alumnos` (
      `no_de_control` int(8) DEFAULT NULL,
      `carrera` varchar(3) DEFAULT NULL,
      `reticula` int(1) DEFAULT NULL,
      `semestre` int(2) DEFAULT NULL,
      `estatus_alumno` varchar(3) DEFAULT NULL,
      `plan_de_estudios` int(1) DEFAULT NULL,
      `apellido_paterno` varchar(14) DEFAULT NULL,
      `apellido_materno` varchar(12) DEFAULT NULL,
      `nombre_alumno` varchar(25) DEFAULT NULL,
      `nip` int(4) DEFAULT NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

    CREATE TABLE IF NOT EXISTS `carreras` (
      `Carrera` varchar(45) DEFAULT NULL,
      `Alumno` varchar(41) DEFAULT NULL,
      `Usuario` int(8) DEFAULT NULL,
      `Contrase単a` int(4) DEFAULT NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

    CREATE TABLE IF NOT EXISTS `registros` (
      `id` int(11) NOT NULL AUTO_INCREMENT,
      `grupos` int(3) DEFAULT NULL,
      `nombre_empleado` varchar(65) DEFAULT NULL,
      `p0` int(18) DEFAULT NULL,
      `p1` int(18) DEFAULT NULL,
      `p2` int(18) DEFAULT NULL,
      `p3` int(18) DEFAULT NULL,
      `p4` int(18) DEFAULT NULL,
      `p5` int(18) DEFAULT NULL,
      `p6` int(18) DEFAULT NULL,
      `p7` int(18) DEFAULT NULL,
      `p8` int(18) DEFAULT NULL,
      `p9` int(18) DEFAULT NULL,
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4;

    CREATE TABLE IF NOT EXISTS `seleccion_materias` (
      `periodo` int(5) DEFAULT NULL,
      `no_de_control` int(8) DEFAULT NULL,
      `materia` varchar(8) DEFAULT NULL,
      `grupo` varchar(3) DEFAULT NULL,
      `status_seleccion` varchar(1) DEFAULT NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

    CREATE TABLE IF NOT EXISTS `grupos` (
      `grupo_index` int(11) NOT NULL AUTO_INCREMENT,
      `periodo` int(5) DEFAULT NULL,
      `materia` varchar(8) DEFAULT NULL,
      `grupo` varchar(3) DEFAULT NULL,
      `capacidad_grupo` int(2) DEFAULT NULL,
      `alumnos_inscritos` int(2) DEFAULT NULL,
      `paralelo_de` varchar(10) DEFAULT NULL,
      `exclusivo_carrera` varchar(10) DEFAULT NULL,
      `exclusivo_reticula` varchar(10) DEFAULT NULL,
      `rfc` varchar(13) DEFAULT NULL,
      `tipo_personal` varchar(1) DEFAULT NULL,
      PRIMARY KEY (`grupo_index`)
    ) ENGINE=InnoDB AUTO_INCREMENT=199 DEFAULT CHARSET=utf8;

    CREATE TABLE IF NOT EXISTS `materias` (
      `materia` varchar(9) DEFAULT NULL,
      `nivel_escolar` varchar(1) DEFAULT NULL,
      `tipo_materia` int(1) DEFAULT NULL,
      `clave_area` int(6) DEFAULT NULL,
      `nombre_completo_materia` varchar(50) DEFAULT NULL,
      `nombre_abreviado_materia` varchar(32) DEFAULT NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;";

    $createGP = "CREATE TABLE IF NOT EXISTS grupos_personal AS SELECT
    personal.rfc,
    nombre_empleado,
    apellidos_empleado,
    materias.materia,
    grupo,
    nombre_abreviado_materia
    FROM
    grupos
    JOIN personal ON grupos.rfc = personal.rfc
    JOIN materias ON grupos.materia = materias.materia;";

    
    while(mysqli_next_result($conn)){;}

    if(isset($_POST["submit-personal"]))importPersonal($conn);
    if(isset($_POST["submit-grupos"]))importGrupos($conn);
    if(isset($_POST["submit-materias"]))importMaterias($conn);
    if(isset($_POST["submit-alumnos"]))importAlumnos($conn);
    if(isset($_POST["submit-carreras"]))importCarreras($conn);
    if(isset($_POST["submit-seleccion-materia"]))importSeleccion($conn);
    if(isset($_POST["create-grupos-personas"]))$resInicial = mysqli_query($conn, $createGP);

    mysqli_query($conn, $createGP);

    mysqli_close($conn);

    function importPersonal($conn){
        $file = $_FILES["upload-personal"]["tmp_name"];
        $file_open = fopen($file,"r");
        while(!feof($file_open)){
            $csv = fgetcsv($file_open);
            $rfc = $csv[0];
            $clave = $csv[1];
            $curp = $csv[2];
            $tarjeta = $csv[3];
            $apellidos = $csv[4];
            $nombre = $csv[5];
            $nombramiento = $csv[6];
            $area = $csv[7];
            $tipo = $csv[8];
            $apellido_p = $csv[9];
            $apellido_m = $csv[10];
            $status = $csv[11];
            $qry = "INSERT INTO personal(rfc,clave_area,curp_empleado,no_tarjeta,apellidos_empleado,nombre_empleado,nombramiento,area_academica,tipo_personal,apellido_paterno,apellido_materno,status_empleado) VALUES ('".$rfc."',".$clave.",'".$curp."',".$tarjeta.",'".$apellidos."','".$nombre."','".$nombramiento."',".$area.",'".$tipo."','".$apellido_p."','".$apellido_m."','".$status."');
            DELETE FROM personal WHERE rfc = 'AAA';";
            $res = mysqli_multi_query($conn, $qry);
            while(mysqli_next_result($conn)){;}
        }
        fclose($file_open);
    }

    function importGrupos($conn){
        $file = $_FILES["upload-grupos"]["tmp_name"];
        $file_open = fopen($file,"r");
        while(!feof($file_open)){
            $csv = fgetcsv($file_open);
            $periodo = $csv[0];
            $materia = $csv[1];
            $grupo = $csv[2];
            $capacidad_grupo = $csv[3];
            $alumnos_inscritos = $csv[4];
            $paralelo_de = $csv[5];
            $exclusivo_carrera = $csv[6];
            $exclusivo_reticula = $csv[7];
            $rfc = $csv[8];
            $tipo_personal = $csv[9];
            $qry = "INSERT INTO grupos(periodo, materia, grupo, capacidad_grupo, alumnos_inscritos,paralelo_de,exclusivo_carrera,exclusivo_reticula,rfc,tipo_personal) VALUES(
                '".$periodo."',
                '".$materia."',
                '".$grupo."',
                '".$capacidad_grupo."',
                '".$alumnos_inscritos."',
                '".$paralelo_de."',
                '".$exclusivo_carrera."',
                '".$exclusivo_reticula."',
                '".$rfc."',
                '".$tipo_personal."'
            )";
            $res = mysqli_multi_query($conn, $qry);
            while(mysqli_next_result($conn)){;}
        }
        fclose($file_open);
    }

    function importMaterias($conn){
        $file = $_FILES["upload-materias"]["tmp_name"];
        $file_open = fopen($file,"r");
        while(!feof($file_open)){
            $csv = fgetcsv($file_open);
            $materia = $csv[0];
            $nivel_escolar = $csv[1];
            $tipo_materia = $csv[2];
            $clave_area = $csv[3];
            $nombre_completo_materia = $csv[4];
            $nombre_abreviado_materia = $csv[5];
            $qry = "INSERT INTO materias(materia, nivel_escolar, tipo_materia, clave_area, nombre_completo_materia,nombre_abreviado_materia) VALUES(
                '".$materia."',
                '".$nivel_escolar."',
                '".$tipo_materia."',
                '".$clave_area."',
                '".$nombre_completo_materia."',
                '".$nombre_abreviado_materia."'
            )";
            $res = mysqli_multi_query($conn, $qry);
            while(mysqli_next_result($conn)){;}
        }
    }

    function importAlumnos($conn){
        $file = $_FILES["upload-alumnos"]["tmp_name"];
        $file_open = fopen($file,"r");
        while(!feof($file_open)){
            $csv = fgetcsv($file_open);
            $no_de_control = $csv[0];
            $carrera = $csv[1];
            $reticula = $csv[2];
            $semestre = $csv[3];
            $estatus_alumno = $csv[4];
            $plan_de_estudios = $csv[5];
            $apellido_paterno = $csv[6];
            $apellido_materno = $csv[7];
            $nombre_alumno = $csv[8];
            $nip = $csv[9];
            $qry = "INSERT INTO alumnos(no_de_control, carrera, reticula, semestre, estatus_alumno,plan_de_estudios,apellido_paterno,apellido_materno,nombre_alumno,nip) VALUES(
                '".$no_de_control."',
                '".$carrera."',
                '".$reticula."',
                '".$semestre."',
                '".$estatus_alumno."',
                '".$plan_de_estudios."',
                '".$apellido_paterno."',
                '".$apellido_materno."',
                '".$nombre_alumno."',
                '".$nip."'
            )";
            $res = mysqli_multi_query($conn, $qry);
            while(mysqli_next_result($conn)){;}
        }
        fclose($file_open);
    }

    function importCarreras($conn){
        $file = $_FILES["upload-carreras"]["tmp_name"];
        $file_open = fopen($file,"r");
        while(!feof($file_open)){
            $csv = fgetcsv($file_open);
            $Carrera = $csv[0];
            $Alumno = $csv[1];
            $Usuario = $csv[2];
            $Contrase単a = $csv[3];
            $qry = "INSERT INTO carreras(Carrera, Alumno, Usuario, Contrase単a) VALUES(
                '".$Carrera."',
                '".$Alumno."',
                '".$Usuario."',
                '".$Contrase単a."'
            )";
            $res = mysqli_multi_query($conn, $qry);
            while(mysqli_next_result($conn)){;}
        }
    }

    function importSeleccion($conn){
        $file = $_FILES["upload-seleccion-materias"]["tmp_name"];
        $file_open = fopen($file,"r");
        while(!feof($file_open)){
            $csv = fgetcsv($file_open);
            $periodo = $csv[0];
            $no_de_control = $csv[1];
            $materia = $csv[2];
            $grupo = $csv[3];
            $status_seleccion = $csv[4];
            $qry = "INSERT INTO seleccion_materias(periodo, no_de_control, materia, grupo, status_seleccion) VALUES(
                '".$periodo."',
                '".$no_de_control."',
                '".$materia."',
                '".$grupo."',
                '".$status_seleccion."'
            )";
            $res = mysqli_multi_query($conn, $qry);
            while(mysqli_next_result($conn)){;}
        }
    }
?>
    </div>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
</body>

</html>